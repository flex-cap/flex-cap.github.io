<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '26.jpg';
var  boxes = [[195, 173, 202, 211],
       [289, 259, 499, 293],
       [302, 259, 308, 264],
       [109, 233, 132, 254],
       [150, 260, 164, 279],
       [ 85, 295, 180, 308],
       [  0, 114, 495, 385],
       [ 74, 300,  91, 311],
       [199, 199, 237, 239],
       [  2, 250, 497, 360],
       [180, 196, 254, 290],
       [ 37, 221,  87, 264],
       [  0,   0, 494, 162],
       [ 35, 212,  96, 310],
       [212, 187, 227, 203],
       [ 70, 232, 163, 311],
       [  0, 148, 495, 278],
       [ 91, 268, 106, 284],
       [  1, 344, 494, 389],
       [ 76, 212,  97, 240],
       [ 78, 244, 123, 269],
       [  0,   0, 490,  46],
       [219, 299, 249, 304],
       [ 69, 241,  77, 249],
       [207, 229, 230, 240],
       [347,  90, 385, 124],
       [ 43, 299,  62, 309],
       [ 39, 249,  77, 307],
       [121, 234, 133, 252],
       [254, 281, 298, 298],
       [ 86, 211,  98, 236],
       [438, 261, 497, 275],
       [120,  92, 216, 146],
       [153, 280, 299, 301],
       [ 59,  86,  94, 127],
       [  2, 109, 496, 212],
       [300, 101, 339, 131],
       [  0,   0, 212,  45],
       [466,  66, 497, 114],
       [131, 259, 259, 303],
       [ 67,  13, 121,  38],
       [ 67, 250,  77, 258],
       [282, 285, 296, 297],
       [180, 242, 216, 291],
       [220, 289, 274, 297],
       [289, 292, 298, 298],
       [ 72, 246, 126, 290],
       [ 60, 291,  76, 306],
       [204,   0, 470,  32],
       [  0, 105,  32, 158],
       [210, 232, 238, 242],
       [155, 114, 215, 143],
       [319, 273, 494, 344],
       [165,  66, 492, 140],
       [ 25,  80,  64, 155],
       [241, 287, 269, 295],
       [119,   0, 207,  36],
       [348,  58, 391, 125],
       [ 65, 278,  76, 293],
       [295,  75, 490, 130],
       [482,  64, 496,  74],
       [114, 262, 125, 276],
       [113, 243, 127, 254],
       [  0, 105,  88, 163],
       [112,  94, 155, 148],
       [202,   1, 231,  35],
       [ 79, 278,  96, 301],
       [444,  88, 474, 116],
       [156, 287, 165, 291],
       [ 99, 277, 118, 299],
       [ 37, 186, 266, 310],
       [104, 262, 115, 269],
       [ 37, 248,  59, 272],
       [166,   0, 205,  32],
       [235, 254, 240, 260],
       [ 63, 101,  94, 152],
       [  0,   0,  44,  42],
       [479,  84, 498, 101],
       [218,  89, 267, 136],
       [ 70, 264, 101, 285],
       [ 56,   0,  89,  19],
       [338,   0, 371,  23],
       [ 76, 253,  93, 266],
       [ 41,   0,  73,  37],
       [ 97, 293, 107, 301],
       [110,   0, 144,  36],
       [384,  79, 414, 122],
       [ 75, 260,  87, 269],
       [ 45, 298,  51, 305],
       [351, 113, 496, 160],
       [355,   0, 385,  22],
       [355, 248, 499, 287],
       [160, 307, 371, 349],
       [  0,  78,  22, 111],
       [124, 298, 180, 307],
       [258,   0, 283,  22],
       [194, 206, 203, 218],
       [ 99, 293, 121, 301],
       [295,   0, 352,  24],
       [178, 287, 190, 297],
       [290,   0, 324,  24]];
var captions = ['a baseball bat', 'white line on the field', 'a white baseball', 'a catchers black safety helmet', 'a brown catchers mitt', 'the batters shadow is on the ground', 'the baseball field', 'a baseball players right foot', 'the shirt is black', 'the dirt is brown', 'a baseball player wearing a black and white uniform', 'the shirt is black', 'spectators watching the game', 'the umpire is crouching', 'the batter is wearing a batting helmet', 'catcher is crouched down', 'green grass on the field', 'catcher wearing knee pad', 'green grass on the field', 'the umpire is wearing a face mask', 'the catcher is wearing a white shirt', 'spectators in the stands', 'home plate on a baseball field', 'the catchers number is 1 2', 'the batters elbow of a baseball player', 'a person sitting in the dugout', 'a baseball players right foot', 'the leg of a man', 'a catchers mask', 'home plate on a baseball field', 'the umpire is wearing a face mask', 'white line on the field', 'a green and white bench', 'the batters box', 'a person wearing a white shirt', 'the dirt is brown', 'a green and white bench', 'spectators in the stands', 'a person sitting in the dug out', 'the batters box', 'a green stadium seat', 'the catchers left elbow', 'home plate on a baseball field', 'the leg of a man', 'home plate white base', 'home plate white base', 'catcher wearing red and white uniform', 'a baseball players cleat', 'spectators in the stands', 'a green and white bench', 'the batters belt is black', 'a green bench', 'the dirt is brown', 'players in the dugout', 'a person sitting in the dugout', 'home plate on a baseball field', 'spectators in the stands', 'a person sitting in the dugout', 'the knee of a man', 'a green fence in the outfield', 'a white baseball cap', 'a catchers mitt', 'the catchers face mask', 'a green bench', 'a green gate', 'spectator in the stand', 'the knee of a catcher', 'a green and white chair', 'a white home plate', 'shin guard on a catcher', 'baseball players on the ball field', 'a catchers glove', 'the umpires black pants', 'spectator in the stand', 'part of a baseball', 'a person sitting in the dugout', 'a person wearing a white shirt', 'a baseball sitting in the dugout', 'a baseball player in the dugout', 'catcher wearing knee and shin guards', 'spectator watching the game', 'spectator watching the game', 'a catchers glove', 'spectator watching the game', 'a baseball catchers right knee', 'spectator in the stand', 'a person sitting in the dugout', 'a white baseball glove', 'a white shoe', 'the dirt is brown', 'spectator watching the game', 'white line on the field', 'white lines on the field', 'a person sitting in the stands', 'home plate on a baseball field', 'spectator in the stand', 'the helmet is black in color', 'home plate on the baseball field', 'spectator in the stand', 'home plate on the baseball field', 'spectator in the stand'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

