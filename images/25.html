<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '25.jpg';
var  boxes = [[ 20, 150, 462, 314],
       [292, 275, 367, 306],
       [ 23, 151, 141, 242],
       [  0, 288, 495, 374],
       [  4,   1, 499, 243],
       [  7, 352,  18, 374],
       [230, 257, 420, 271],
       [188, 279, 269, 302],
       [ 25, 245, 119, 272],
       [ 19, 250,  59, 269],
       [330, 280, 374, 307],
       [  1, 291, 496, 310],
       [368, 326, 375, 332],
       [228, 301, 288, 313],
       [227, 302, 256, 312],
       [256, 315, 300, 328],
       [437, 267, 461, 294],
       [114, 269, 227, 274],
       [372, 326, 375, 332],
       [111, 258, 243, 281],
       [  3, 232, 496, 275],
       [237, 273, 375, 309],
       [  1, 308,  33, 327],
       [  0, 315,   6, 323],
       [228, 257, 334, 269],
       [ 59, 175, 109, 234],
       [339, 259, 420, 271],
       [  0, 346, 102, 373],
       [341, 260, 352, 270],
       [323, 235, 499, 268],
       [428, 305, 436, 311],
       [  4, 307, 499, 340],
       [324, 259, 333, 269],
       [118, 276, 273, 301],
       [271, 259, 282, 268],
       [ 87, 334, 116, 339],
       [ 27, 255,  45, 282],
       [354, 250, 380, 281],
       [118, 314, 125, 322],
       [  8, 277,  34, 284],
       [241, 305, 247, 311],
       [ 16, 250,  42, 262],
       [445, 268, 449, 272],
       [219, 258, 246, 277],
       [227, 303, 238, 311],
       [  0, 295, 492, 303],
       [172, 247, 181, 260],
       [355, 244, 364, 246],
       [269, 303, 290, 312],
       [286, 259, 296, 269],
       [259, 304, 269, 312],
       [411, 261, 420, 271],
       [372, 243, 376, 246],
       [267, 322, 273, 327],
       [281, 241, 285, 244],
       [429, 295, 437, 300],
       [  5, 310,  18, 322],
       [107, 261, 429, 279],
       [247, 302, 261, 311],
       [354, 270, 458, 301],
       [191, 277, 299, 313],
       [  8, 278,  19, 284],
       [297, 259, 309, 269],
       [ 19, 309,  33, 326],
       [468, 301, 497, 311],
       [  0, 242,  43, 259],
       [461, 274, 478, 285],
       [  2, 303, 493, 312],
       [445, 265, 450, 269],
       [410, 263, 459, 298],
       [361, 260, 372, 270],
       [138, 260, 215, 279],
       [200, 267, 209, 279],
       [235, 302, 245, 311],
       [  0, 257,  38, 280],
       [427, 297, 499, 312],
       [ 31, 267,  39, 275]];
var captions = ['the plane is white and blue', 'engine on the plane', 'tail of the plane', 'the tarmac is grey', 'the sky is clear', 'a white ladder', 'the name of the airline on the side of the plane', 'the engine of a plane', 'wing of a plane', 'the wing of a plane', 'engine on the plane', 'the runway is paved', 'a small white cone', 'wheels on the plane', 'wheels of the airplane', 'white car on the runway', 'the nose of a plane', 'gold stripe on the plane', 'a white cone on the ground', 'the gold stripe on the plane', 'mountains in the background', 'jet engine on the airplane', 'a small vehicle on the runway', 'a yellow box', 'the word singapore on the side of the plane', 'the logo on the tail of the plane', 'the word airlines on the side of the plane', 'a cart on the tarmac', 'the letter is blue', 'mountains in the background', 'the wheel of a plane', 'the runway is paved', 'the letter is blue', 'the wing of a plane', 'the letter is black', 'yellow line on the runway', 'a red and white tower', 'the door of a plane', 'a black wheel on the ground', 'a white building in the background', 'the wheel of a plane', 'the wing of a plane', 'the window of a plane', 'the door of the airplane', 'the wheel of a plane', 'the runway is made of concrete', 'small window on side of plane', 'side of a plane', 'the car is white', 'the letter is blue', 'the nose of the airplane', 'the letter is black', 'window of a plane', 'the wheel of a car', 'this is the letter t', 'the front wheel of the airplane', 'a yellow box on the ground', 'the windows on the side of the plane', 'the wheel of a plane', 'the engine of a plane', 'the engine of a plane', 'a white building in the background', 'the letter is blue', 'a white luggage cart', 'a white truck on the runway', 'the tip of the wing is pointed', 'the nose of a plane', 'the runway is paved', 'the window of a plane', 'the nose of a plane', 'the letter is black', 'windows on side of plane', 'the door of the airplane', 'the wheel of a plane', 'trees in the distance', 'a truck on the runway', 'the tail of the airplane'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

