<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '34.jpg';
var  boxes = [[ 74, 158, 197, 288],
       [268, 171, 337, 294],
       [  0, 166, 113, 291],
       [  2, 279, 497, 372],
       [220, 231, 410, 295],
       [ 47, 190,  90, 257],
       [306, 240, 383, 270],
       [296, 229, 332, 247],
       [119, 169, 170, 219],
       [369, 229, 411, 265],
       [392, 329, 421, 359],
       [ 77, 166, 119, 201],
       [297, 274, 310, 292],
       [299, 268, 336, 295],
       [395, 115, 418, 305],
       [168, 157, 197, 187],
       [325, 271, 336, 294],
       [222, 244, 316, 296],
       [  1,   0, 128, 270],
       [268, 249, 295, 290],
       [268,   0, 499, 304],
       [190, 176, 198, 187],
       [287, 222, 292, 246],
       [314, 272, 324, 293],
       [221, 253, 258, 292],
       [310, 251, 328, 259],
       [ 23, 194,  88, 271],
       [129, 225, 138, 243],
       [384, 230, 393, 244],
       [ 86, 166,  97, 177],
       [ 81, 245, 107, 281],
       [117, 234, 137, 281],
       [297, 246, 349, 274],
       [111, 251, 121, 283],
       [  0, 268,  34, 290],
       [221, 270, 231, 292],
       [ 73, 240,  82, 244],
       [286, 251, 304, 286],
       [176, 156, 186, 167],
       [481,  64, 499, 313],
       [120,   0, 256, 283],
       [265, 170, 290, 192],
       [  0,   0, 496, 310],
       [ 53, 104,  68, 246],
       [ 55, 214,  83, 270],
       [403, 255, 411, 264],
       [311, 237, 393, 256],
       [221, 258, 234, 281],
       [308, 252, 340, 272],
       [423, 189, 458, 283],
       [ 66, 168, 129, 288],
       [105, 209, 132, 248],
       [ 75, 222, 136, 285],
       [275, 181, 309, 230],
       [ 81, 211, 111, 237],
       [111, 192, 152, 238],
       [317, 235, 334, 247],
       [ 75, 179,  93, 190],
       [292, 266, 300, 289],
       [190,   3, 306, 275],
       [360, 255, 457, 374],
       [386,   3, 426, 305],
       [  2, 286, 180, 373],
       [279, 178, 290, 185],
       [238, 252, 466, 374],
       [284, 204, 291, 245],
       [277, 272, 296, 287],
       [185, 161, 195, 174]];
var captions = ['a giraffe in the grass', 'a giraffe in the distance', 'a giraffe in the grass', 'tall green grass in the field', 'a giraffe in the photo', 'the neck of a giraffe', 'the neck of a giraffe', 'neck of a giraffe', 'the neck of a giraffe', 'the head of a giraffe', 'a green leaf on the grass', 'the head of a giraffe', 'leg of the giraffe', 'the legs of the giraffe on the right', 'a tree trunk', 'head of a giraffe', 'leg of a giraffe', 'a giraffe is standing', 'tall green trees behind giraffes', 'brown spots on the giraffe', 'the trees are tall', 'the nose of a giraffe', 'brown spot on giraffe', 'leg of a giraffe', 'the giraffe has a tail', 'brown spot on giraffe', 'the neck of a giraffe', 'brown spot on giraffe', 'the giraffe has horns', 'the giraffe has horns', 'leg of the giraffe', 'the tail of a giraffe', 'brown spots on the giraffe', 'leg of the giraffe', 'the giraffe is brown and white', 'tail of a giraffe', 'brown spot on giraffe', 'brown spots on the giraffe', 'the giraffe has horns', 'a tall tree trunk', 'a tree with green leaves', 'the head of a giraffe', 'the trees are green', 'a tall tree trunk', 'neck of a giraffe', 'the mouth of a giraffe', 'the neck of a giraffe', 'brown spot on giraffe', 'brown spots on giraffe', 'a tree trunk', 'a giraffe in the field', 'neck of a giraffe', 'a giraffe is standing', 'the giraffe has a long neck', 'brown spots on the giraffe', 'neck of a giraffe', 'brown spot on giraffe', 'the ear of a giraffe', 'brown spot on giraffe', 'tall green leafy tree', 'a small green leaf', 'a tall tree trunk', 'tall green grass in a field', 'the giraffe has a white ear', 'tall grass in front of giraffes', 'the neck of a giraffe', 'brown spot on giraffe', 'the giraffe has an eye'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

