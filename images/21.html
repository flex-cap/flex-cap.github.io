<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '21.jpg';
var  boxes = [[  2, 208, 497, 371],
       [221, 166, 382, 280],
       [350, 206, 374, 264],
       [ 47, 148,  98, 163],
       [  5,   1, 487, 212],
       [ 35,  51,  51,  76],
       [ 15,   1,  27, 207],
       [293, 219, 327, 281],
       [427, 158, 472, 170],
       [416, 131, 427, 144],
       [411, 236, 495, 373],
       [  3,   0,  46, 202],
       [427, 186, 440, 203],
       [ 71,  50, 114, 108],
       [ 83, 143, 378, 290],
       [221, 134, 270, 147],
       [ 43, 146, 169, 165],
       [328,  28, 349,  67],
       [159,  53, 198, 110],
       [163,   1, 193,  39],
       [ 77,   0, 109,  32],
       [237,  60, 273, 112],
       [237,   0, 270,  44],
       [230, 218, 333, 280],
       [382,  95, 400, 135],
       [313, 151, 427, 160],
       [ 41, 172,  56, 212],
       [438, 189, 498, 229],
       [ 46, 188,  84, 209],
       [271, 146, 306, 177],
       [376, 180, 388, 220],
       [  0, 182,  16, 207],
       [383, 179, 398, 217],
       [379,   0, 397,  22],
       [472,  56, 498, 187],
       [329,  90, 349, 131],
       [110, 158, 165, 202],
       [427, 181, 441, 214],
       [261, 137, 268, 145],
       [436, 100, 462, 136],
       [ 41, 177,  53, 194],
       [319, 178, 384, 194],
       [141, 158, 199, 210],
       [ 29, 121, 179, 210],
       [ 78,  63, 107, 101],
       [327,   0, 348,  16],
       [ 83, 156, 114, 208],
       [ 37,  23,  54,  76],
       [301,   1, 471, 209],
       [430,  96, 467, 153],
       [  0, 319,  18, 359],
       [309, 177, 386, 229],
       [ 77, 136,  86, 146],
       [ 22,   0, 299, 124],
       [287, 134, 298, 142],
       [481, 162, 499, 167],
       [243,  72, 266, 106],
       [368, 195, 382, 226],
       [426, 157, 472, 196],
       [100, 149, 236, 216],
       [ 19, 149,  23, 155],
       [234, 137, 240, 145],
       [ 48, 209,  54, 212],
       [ 40, 208,  48, 211],
       [363, 117, 375, 135],
       [479, 139, 489, 177],
       [385, 183, 393, 198],
       [245, 216, 291, 263],
       [242,  61, 259, 170],
       [ 38,  23,  53,  42],
       [387, 179, 399, 197],
       [ 84, 180, 103, 191],
       [442, 215, 456, 227],
       [ 88, 143, 157, 198],
       [245, 236, 271, 285],
       [148, 236, 270, 298],
       [479, 139, 488, 150],
       [476, 211, 491, 233],
       [285, 230, 299, 252],
       [424, 179, 453, 214],
       [275, 169, 286, 177],
       [478, 213, 486, 229],
       [299, 166, 332, 178],
       [293,   0, 309, 122],
       [275, 172, 298, 186],
       [316, 178, 341, 197],
       [427, 199, 439, 215],
       [443, 184, 453, 198],
       [283, 175, 296, 185],
       [480, 143, 497, 152],
       [ 76, 135, 140, 147],
       [445, 180, 456, 193],
       [108, 158, 114, 165]];
var captions = ['a brick paved street', 'a red and black cart', 'a red and black cart wheel', 'red and white striped awning', 'a white building', 'a round white satellite dish', 'a tall black lamp post', 'red wheel on a carriage', 'blue awning on building', 'a green sign on the building', 'yellow lines on the road', 'a street light', 'a person wearing a red shirt', 'window on a building', 'a horse and carriage', 'a blue and yellow sign', 'red and white awning on building', 'a window on the building', 'a window on the building', 'window on the building', 'window on white building', 'a window on the building', 'window on side of building', 'red wheels on the wheels of the carriage', 'window on side of building', 'a white awning', 'a woman walking on the street', 'a black car parked on the side of the road', 'a bench in front of the building', 'the man is wearing a red shirt', 'a person walking on the street', 'a black trash can', 'a person walking on the street', 'window on side of building', 'white building with white windows', 'window on side of building', 'the horse is wearing a black harness', 'a person walking on the street', 'the blue letter r', 'window on side of building', 'a person in a white shirt', 'black seat on a carriage', 'the harness on the horse', 'a red and white awning', 'window on a building', 'a window on the building', 'the head of a horse', 'a light on the side of the building', 'white building with windows', 'a window on the building', 'a black and white dog', 'the cart is black', 'the letter is white', 'windows on the building', 'the head of the man', 'a white sign on the building', 'a window on the building', 'the wheel on the carriage', 'a blue awning on a building', 'the horse is wearing a harness', 'a yellow sign on the building', 'blue letter on sign', 'a woman is wearing white shoes', 'a white shoe', 'a street light', 'a white street light', 'a person in a white shirt', 'the front legs of the horse', 'a white pole', 'a light on the building', 'a person in a white shirt', 'the nose of a horse', 'the wheel of a car', 'the horse is wearing a harness', 'the leg of a horse', 'white legs on a horse', 'a white street sign', 'the back tire of a car', 'the wheel is red', 'a person walking on the street', 'the hand of a man', 'the wheel of a car', 'the man is wearing black pants', 'a white brick building', 'the seat is black in color', 'the seat is black in color', 'leg of the man', 'a person wearing a red shirt', 'the seat is black in color', 'a white sign on the building', 'a sign for a restaurant', 'a person wearing a red shirt', 'the eye of a horse'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

