<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '29.jpg';
var  boxes = [[ 71,  92, 403, 302],
       [ 64,   3, 102, 332],
       [310, 238, 326, 247],
       [379, 236, 393, 245],
       [ 63,  85,  66,  93],
       [ 19,  49,  41, 246],
       [ 66,  96, 126, 126],
       [  0, 108,  55, 156],
       [315, 240, 325, 246],
       [349, 174, 356, 181],
       [120,  98, 189, 203],
       [137, 131, 157, 181],
       [395, 276, 498, 327],
       [346, 218, 362, 235],
       [268,  38, 278, 131],
       [ 42,   0, 493, 122],
       [ 64,  99,  73, 114],
       [106,  98, 134, 128],
       [474,  71, 498, 105],
       [ 45, 192,  95, 332],
       [ 51,  57,  62, 190],
       [124,  98, 176, 130],
       [168,  82, 483,  98],
       [309, 192, 344, 210],
       [291, 173, 305, 210],
       [324,  46, 330,  98],
       [ 58,  59,  70, 163],
       [299, 248, 405, 300],
       [365, 134, 499, 312],
       [393, 171, 400, 208],
       [307, 172, 345, 210],
       [145, 266, 265, 331],
       [206, 156, 219, 216],
       [  0, 135,  82, 331],
       [208,  41, 216, 119],
       [ 19,  48,  33, 175],
       [173, 204, 186, 220],
       [176,  55, 183, 120],
       [ 19,  58,  29, 112],
       [337,  84, 486,  92],
       [157, 128, 214, 222],
       [  0,  93, 121, 157],
       [361, 188, 392, 209],
       [192, 165, 210, 207],
       [188,  53, 193, 115],
       [ 93,  33, 106,  42],
       [177,  80, 423, 146],
       [284, 143, 406, 298],
       [143, 110, 254, 232],
       [168,  82, 264, 123],
       [ 84, 121, 204, 331],
       [328,   0, 499,  45],
       [ 28,   2, 497,  51],
       [ 19,  51,  69, 220],
       [381, 149, 402, 169],
       [206, 140, 291, 168],
       [162, 197, 205, 230],
       [195, 209, 206, 230],
       [199,  38, 207, 118],
       [ 26, 139,  42, 247],
       [261,   1, 276, 131],
       [251, 252, 262, 268],
       [294, 169, 398, 212],
       [231, 240, 289, 282],
       [205,  92, 244, 128],
       [400, 170, 409, 177],
       [ 70,   6, 297, 119],
       [257, 210, 271, 219],
       [247, 247, 258, 264],
       [166, 307, 249, 329],
       [  7,   0, 496, 330],
       [252, 129, 324, 150],
       [226, 237, 238, 253],
       [ 90, 106, 110, 124],
       [101,   0, 180,  44],
       [255, 148, 291, 167],
       [182, 124, 346, 152],
       [  4, 128,  26, 156],
       [320,   8, 359, 107],
       [295,  88, 359, 146],
       [155, 144, 161, 179],
       [399,   6, 499,  29],
       [304,  90, 336, 139],
       [321, 261, 395, 295],
       [205, 143, 295, 262],
       [ 63,  81,  84,  95],
       [173,  83, 265,  92],
       [349, 222, 359, 232],
       [164,  11, 297,  61],
       [164, 130, 204, 150],
       [277, 174, 288, 269],
       [ 65,   1,  84, 191],
       [210, 142, 241, 158],
       [195, 203, 208, 220],
       [433, 125, 438, 137],
       [166,  18, 210, 118],
       [162,  57, 181, 116],
       [324,  75, 399,  84],
       [ 24, 130,  48, 154],
       [110,  72, 117,  94],
       [205,  92, 223, 124],
       [385, 258, 406, 276],
       [  0,  97,  57, 244],
       [227,  92, 244, 125],
       [ 82,  12, 295,  34]];
var captions = ['a train is on the tracks', 'a brown pole', 'the left headlight on the train', 'the left headlight on the train', 'a red train traffic light', 'a brown pole next to the train', 'a train car on a track', 'a brown wooden building', 'the left headlight on the train', 'red light on front of train', 'a silver and green train car', 'green window on side of train', 'a set of train tracks', 'a logo on the front of the train', 'this is a pole', 'power lines above the train', 'a train car on a track', 'a silver train passenger car', 'a black roof on a building', 'a railroad track', 'a brown wooden pole', 'silver train car', 'black wires above the train', 'windshield on the train', 'window on side of train', 'this is a pole', 'a brown pole', 'bumper of train is black', 'a field of green grass', 'a trains side windshield wiper', 'window on a train', 'gravel on the tracks', 'door on side of train', 'grass growing beside the train tracks', 'this is a pole', 'a brown wooden pole', 'the wheels of a train', 'this is a pole', 'a brown pole', 'a long electrical power line', 'red train car', 'a train is on the other side of the tracks', 'windshield of the train', 'the door of the train', 'this is a pole', 'a house in the distance', 'wires above the train', 'front of train is red', 'red train car', 'wires above the train', 'train tracks on the ground', 'a long electrical power line', 'wires above the train', 'a pole holding electrical wires', 'the trains horn', 'black roof on train', 'wheels on the train', 'a black wheel on the train', 'this is a pole', 'a pole', 'this is a pole', 'a small black wheel', 'two windows on front of train', 'wheels on the train', 'a white metal pole', 'a trains side mirror', 'power lines above the train', 'the number on the train', 'a small black wheel', 'the train tracks are brown', 'a train is on a train track', 'the train has black roof', 'a small black wheel', 'a silver train passenger car', 'green grass on the hill', 'black roof of train', 'the train has a black roof', 'a brown wooden box', 'a street light', 'a black metal pole', 'window on side of train', 'a long electrical power line', 'a train conductor on train', 'black bumper on front of train', 'red train car', 'a red train car', 'this is a wire', 'a logo on the front of the train', 'wires above the train', 'windows on side of train', 'door on side of train', 'a brown pole', 'black window on train', 'a black bumper on a train', 'a white pole in the background', 'a brown electrical pole', 'this is a pole', 'this is a wire', 'a person walking on the sidewalk', 'a pole', 'a pole holding wires', 'the front bumper of a train', 'a wooden electrical pole', 'a metal pole on a train', 'power lines above the train'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

