<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '00.jpg';
var  boxes = [[ 37, 303, 127, 430],
       [451, 224, 539, 314],
       [548, 208, 564, 219],
       [301, 293, 370, 368],
       [250, 211, 318, 300],
       [659,   0, 717,  86],
       [577, 154, 590, 163],
       [375, 271, 429, 326],
       [466, 306, 517, 405],
       [639,   0, 719, 136],
       [353, 245, 447, 310],
       [655,   0, 794, 400],
       [350, 274, 401, 336],
       [257, 296, 305, 390],
       [ 11,   2,  39, 453],
       [122,   2, 146, 409],
       [420, 213, 436, 245],
       [604, 207, 612, 219],
       [482, 199, 503, 217],
       [340, 136, 347, 255],
       [569, 209, 574, 225],
       [  0,   0, 207, 228],
       [315, 204, 324, 226],
       [125, 157, 139, 211],
       [281, 215, 306, 272],
       [536, 206, 549, 239],
       [349, 266, 369, 293],
       [268, 112, 295, 194],
       [  2, 249, 230, 298],
       [593, 207, 602, 228],
       [301, 252, 444, 368],
       [499, 392, 512, 406],
       [474, 395, 489, 411],
       [676,   1, 702,  55],
       [536, 215, 543, 235],
       [644, 200, 653, 243],
       [  4, 227, 796, 595],
       [420, 207, 442, 274],
       [475, 391, 512, 410],
       [550, 211, 639, 241],
       [352, 207, 383, 230],
       [ 65,  39, 121,  65],
       [ 41, 205, 122, 253],
       [ 66,  98, 125, 125],
       [148,   0, 620, 370],
       [378, 245, 420, 283],
       [ 38,   3,  53, 237],
       [ 66, 158, 120, 182],
       [130, 205, 179, 244],
       [438, 217, 448, 243],
       [270, 111, 293, 126],
       [267, 108, 279, 123],
       [331, 117, 354, 141],
       [412, 279, 448, 310],
       [271, 180, 293, 192],
       [  6,   0, 147, 450],
       [361, 247, 399, 291],
       [387, 206, 409, 226],
       [280, 385, 297, 398],
       [  0, 175,  10, 239],
       [268, 382, 285, 397],
       [167, 225, 175, 243],
       [  0, 208,  10, 241],
       [ 89, 232, 102, 251],
       [424, 263, 441, 281],
       [275, 115, 288, 125],
       [621,   1, 651, 232],
       [242, 190, 250, 207],
       [624, 181, 631, 193],
       [108, 231, 119, 250],
       [634, 210, 640, 229],
       [578, 153, 592, 225],
       [331, 112, 354, 255],
       [254, 154, 269, 234],
       [592, 202, 617, 220],
       [309, 293, 370, 333],
       [544, 200, 563, 220],
       [650,  92, 705, 105],
       [ 15, 174,  36, 195],
       [646, 218, 653, 240],
       [261, 158, 268, 181],
       [474, 178, 494, 195],
       [646, 106, 695, 118],
       [408, 242, 455, 308],
       [249, 192, 317, 400],
       [390, 208, 400, 226],
       [670,  62, 703,  73],
       [639,   2, 662, 128],
       [425, 198, 448, 224],
       [682, 107, 699, 124],
       [265, 132, 270, 142],
       [429, 211, 448, 231],
       [372, 276, 399, 301],
       [630, 199, 636, 223],
       [228, 203, 234, 222],
       [262, 107, 277, 149],
       [381, 212, 393, 259],
       [636,  57, 643, 120],
       [538, 224, 547, 239],
       [208, 202, 251, 232],
       [266, 202, 290, 226],
       [593, 184, 598, 196],
       [594, 172, 600, 187],
       [636, 125, 679, 136],
       [418, 238, 427, 261],
       [428, 221, 440, 240],
       [383, 249, 405, 271],
       [215, 181, 220, 227],
       [453, 220, 539, 403],
       [ 48,   0, 140, 207],
       [360, 298, 394, 335],
       [656,  84, 710,  94],
       [334, 247, 374, 299],
       [ 99, 177, 107, 196],
       [646, 205, 654, 222],
       [142,   2, 155, 230],
       [208, 204, 218, 231],
       [331, 295, 366, 317],
       [690,  97, 711, 114],
       [275,  98, 289, 112],
       [266,  96, 300, 231],
       [570, 198, 574, 207],
       [146,   0, 214, 232],
       [352, 215, 361, 230],
       [475, 209, 485, 227],
       [542, 204, 548, 209],
       [425, 235, 465, 276],
       [104, 175, 122, 208]];
var captions = ['a black trash can', 'the man is wearing a orange jacket', 'a yellow car', 'a bench on the sidewalk', 'a grey sweatshirt', 'red and white sign on the side of the building', 'green street sign on a green pole', 'bench on the sidewalk', 'man wearing brown pants', 'red and white sign on the side of the building', 'a bicycle on the sidewalk', 'a red brick building', 'bench on the sidewalk', 'man wearing blue jeans', 'a white pole on the sidewalk', 'a tall white pole', 'a person wearing a blue shirt', 'a person walking on a sidewalk', 'the man is wearing a black hat', 'a tall metal pole', 'person walking on the street', 'a brown building', 'a person walking on a street', 'a white sign on a pole', 'a black bag on a mans shoulder', 'person walking on the sidewalk', 'the back tire of the bike', 'a white street sign', 'a white line in the street', 'person walking on the street', 'bench on the sidewalk', 'shoe on the mans foot', 'shoe on the mans foot', 'white letters on the red sign', 'the person is walking', 'person walking on the sidewalk', 'a brick paved street', 'a person walking on a sidewalk', 'the mans shoes are black', 'a sidewalk', 'car on the street', 'window on the building', 'car on the street', 'window on the building', 'trees lining the street', 'a bicycle on the sidewalk', 'a white pole', 'window on the building', 'car on the street', 'the man is wearing a black hat', 'the arrow on the sign is white', 'arrow on the sign', 'red and white sign on the pole', 'tire on the bench', 'a red and white sign', 'a white pole on the sidewalk', 'a bicycle on the sidewalk', 'car on the street', 'white shoe on a foot', 'person walking on the sidewalk', 'white shoe on a foot', 'tire of a vehicle', 'a person walking on the sidewalk', 'tire on the car', 'the back tire of the bike', 'arrow on the sign', 'a tall street light', 'the green traffic light', 'a green street sign', 'tire of a vehicle', 'a person walking on a sidewalk', 'a green street sign', 'a tall street light', 'a white sign on a pole', 'a person walking on a sidewalk', 'the bench is brown', 'a person walking on the sidewalk', 'a white and black street sign', 'a person walking on the sidewalk', 'a person walking on a sidewalk', 'a white sign on the pole', 'the white sign on the side of the building', 'a white and black street sign', 'a bicycle on the sidewalk', 'man wearing a gray jacket', 'a person wearing a blue shirt', 'white letters on sign', 'a red and white sign', 'a red street sign', 'a black light on the building', 'arrow on the sign', 'a person wearing a blue hat', 'the bench is brown', 'person walking on the street', 'a green street sign', 'a white arrow on a sign', 'a person walking on a sidewalk', 'a white sign on the building', 'the white bag of the man', 'a car on a street', 'the man has a beard', 'a green street sign', 'a green street sign', 'a white and black street sign', 'the blue trash can', 'a person wearing a blue shirt', 'the tire of the bike', 'a red light on a post', 'the man is wearing a orange jacket', 'a tall red brick building', 'the bench is brown', 'a white and black street sign', 'a bicycle leaning against a bench', 'a person walking on the sidewalk', 'a person walking on a sidewalk', 'a tall street light', 'a person wearing a red shirt', 'the bench is brown', 'a street light', 'a green traffic light', 'a white street sign', 'a person walking on a sidewalk', 'a tall street light', 'car on the street', 'the man has a black hair', 'the head of a man', 'the back of a bench', 'a person walking on the sidewalk'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

