<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '09.jpg';
var  boxes = [[188, 197, 198, 255],
       [ 68,  95, 168, 259],
       [  0, 106, 236, 297],
       [355, 275, 384, 331],
       [360, 215, 371, 228],
       [162, 186, 215, 263],
       [186, 179, 220, 197],
       [401, 223, 482, 335],
       [ 84, 234, 171, 333],
       [174, 289, 222, 317],
       [273, 222, 308, 240],
       [375,   1, 498, 234],
       [332, 119, 357, 127],
       [259,   1, 354, 191],
       [256, 203, 305, 258],
       [221, 254, 329, 371],
       [295, 138, 390, 221],
       [  6,  11, 495, 374],
       [  0, 230, 105, 372],
       [ 29, 293,  99, 340],
       [366, 275, 386, 290],
       [322, 217, 357, 249],
       [239, 336, 379, 374],
       [  2, 338,  39, 369],
       [  0, 233,  59, 287],
       [126,  54, 204, 174],
       [  0, 317,  54, 357],
       [  4, 209, 497, 374],
       [  7, 110,  76, 168],
       [171,   0, 243,  92],
       [168,   0, 243, 179],
       [186,  92, 243, 174],
       [ 33, 338,  52, 355],
       [  0,  78,  34, 122],
       [ 14, 337,  37, 355],
       [  3, 233,  58, 252],
       [116, 335, 219, 374],
       [316,  98, 360, 146],
       [184, 179, 219, 255],
       [  1, 300, 113, 373],
       [400, 289, 471, 334],
       [139,  10, 179,  59],
       [  0, 172,  14, 183],
       [  0, 110,  84, 262],
       [  0, 222, 210, 372],
       [332, 133, 356, 146],
       [  0, 163,  62, 212],
       [315, 216, 358, 274],
       [ 98,  92, 127, 119],
       [314, 217, 365, 323],
       [284, 302, 301, 314],
       [241,   0, 499, 246],
       [262,   0, 354,  98],
       [ 25, 174,  44, 189],
       [329, 113, 358, 147],
       [  1, 346,  28, 367],
       [366, 284, 370, 288],
       [416, 236, 428, 254],
       [440, 297, 470, 335],
       [168, 337, 202, 371],
       [300, 246, 307, 252],
       [125,   1, 210, 287],
       [126,  73, 134,  77],
       [ 91,  34, 139,  92],
       [328, 304, 339, 322],
       [315, 241, 328, 274],
       [  4, 246,  57, 264],
       [319, 165, 365, 203],
       [333, 313, 340, 323],
       [412, 290, 428, 305],
       [219, 318, 225, 324],
       [ 47, 294,  97, 326],
       [214, 288, 221, 299],
       [162,  46, 172,  50],
       [272, 255, 298, 285],
       [363, 275, 372, 281],
       [303, 223, 308, 230],
       [185, 174, 214, 184],
       [257, 238, 271, 260],
       [  0, 248,  42, 269],
       [287,  97, 388, 312],
       [400, 297, 430, 327],
       [  0, 170,  44, 191],
       [262,  18, 265,  27],
       [ 67,  21, 197, 374],
       [259, 212, 302, 239],
       [446, 224, 461, 236],
       [160, 171, 202, 200],
       [353, 125, 412, 159],
       [221, 203, 387, 374],
       [ 51, 152,  80, 199]];
var captions = ['white wii remote strap', 'a red shirt on a woman', 'a brown couch', 'a white wii controller in a mans hand', 'watch on mans wrist', 'the man is wearing shorts', 'a white wii controller', 'a stuffed dog on the floor', 'a pair of black shorts', 'a pair of glasses', 'man wearing black glasses', 'blinds on the window', 'the man is wearing glasses', 'blinds in the window', 'a man wearing a black hat', 'a yellow shirt on a man', 'the man is wearing a green shirt', 'a man and woman playing the wii', 'a black coffee table', 'a stack of magazines', 'a white game controller', 'a white video game controller', 'man wearing blue jeans', 'a black remote control', 'papers on the table', 'the man is wearing a gray shirt', 'a magazine on a table', 'a brown wooden floor', 'a brown leather pillow', 'blinds in the window', 'a window behind the man', 'blinds in the window', 'a black remote control', 'a framed picture on the wall', 'a remote control on a table', 'papers on the table', 'man wearing a gray shirt', 'the man has brown hair', 'wii remote in the mans hand', 'a black coffee table', 'white socks on the dog', 'the head of a man', 'the cat is white', 'a brown leather couch', 'a black coffee table', 'the chin of a man', 'a stuffed animal on the couch', 'a white video game controller', 'necklace around womans neck', 'man holding a white game controller', 'a logo on a shirt', 'white blinds on windows', 'blinds in the window', 'a black and white cat', 'the man is smiling', 'a black remote control', 'a ring on a mans finger', 'a white sock on a foot', 'white socks on the dog', 'neck of a person', 'the mouth of a man', 'man standing in living room', 'the mouth of a woman', 'the woman is smiling', 'a silver watch on a mans wrist', 'the chin of a man', 'papers on the table', 'the shirt is green', 'a silver watch on a wrist', 'a white wii remote', 'the mouth of a man', 'a book on the table', 'the eye of a man', 'the man is light skinned', 'necklace around the boy', 'a white wii controller', 'the eye of a man', 'a white wii controller', 'the ear of a man', 'papers on the table', 'man wearing a green shirt', 'white socks on a man', 'a white and black stuffed animal', 'a light switch', 'woman wearing a red shirt', 'a black hat', 'a stuffed animal dog', 'the hand of a man', 'a white pillow behind a man', 'a man wearing a black cap', 'a stuffed animal on the arm of the couch'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

