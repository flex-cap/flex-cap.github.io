<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '36.jpg';
var  boxes = [[246, 128, 289, 191],
       [188, 131, 221, 353],
       [  0, 138,  38, 201],
       [  0,   8, 346, 493],
       [281, 106, 373, 250],
       [ 76, 104,  94, 134],
       [  0,  91,  84, 497],
       [  0, 255,  66, 304],
       [  0, 282,  76, 498],
       [  3,   0, 370, 104],
       [342, 197, 368, 237],
       [255, 182, 321, 270],
       [ 21,  97,  35, 110],
       [341, 105, 374, 205],
       [348, 104, 373, 137],
       [136, 250, 324, 461],
       [ 87,  71, 367, 286],
       [154, 220, 315, 292],
       [ 99, 145, 116, 162],
       [293, 175, 332, 223],
       [316, 145, 352, 187],
       [ 83, 108, 214, 305],
       [129,  26, 218,  81],
       [  0,  89,  36, 139],
       [294, 175, 317, 202],
       [ 76, 135, 128, 257],
       [ 91, 167, 115, 188],
       [  0,  96, 145, 286],
       [129,  26, 145,  41],
       [142,   3, 262, 361],
       [272, 101, 287, 128],
       [142, 256, 157, 317],
       [285, 108, 318, 131],
       [ 17, 239,  30, 264],
       [ 84, 185, 122, 254],
       [361, 103, 373, 114],
       [286, 120, 300, 133],
       [102, 184, 162, 301],
       [ 37,  82, 174, 145],
       [ 37, 103,  95, 153],
       [  0,  89,  43, 205],
       [163, 293, 266, 406],
       [235, 119, 246, 132],
       [239,  82, 274, 116],
       [ 74, 125, 153, 297],
       [214, 382, 222, 391],
       [ 10, 105,  36, 136],
       [172,   0, 220,  94],
       [302, 219, 310, 228],
       [  0,  93,  90, 157],
       [ 87, 144, 120, 189],
       [238, 138, 244, 143],
       [362, 155, 373, 193],
       [219, 184, 250, 229],
       [ 35, 124,  69, 154],
       [114, 191, 119, 197],
       [ 95, 144, 108, 158],
       [362, 136, 374, 156],
       [ 98, 199, 121, 214],
       [115,  82, 173, 126],
       [175,   0, 187,  15],
       [206, 110, 247, 148],
       [340, 123, 362, 146],
       [165, 237, 196, 305],
       [115, 116, 209, 206],
       [202,  94, 217, 109],
       [128,  13, 301, 196],
       [185, 111, 249, 353],
       [179, 172, 221, 215],
       [239,  82, 254,  97],
       [285, 122, 316, 164],
       [198, 109, 214, 126],
       [ 56, 110,  74, 134],
       [  1, 185,  82, 239],
       [221, 365, 227, 371],
       [360, 107, 374, 119],
       [297, 180, 308, 192],
       [175,   0, 204,  50],
       [121, 128, 136, 144],
       [117, 129, 146, 190],
       [300, 125, 346, 158],
       [ 92, 146, 100, 163],
       [ 78, 160,  98, 181],
       [309, 106, 347, 129],
       [  0, 323,  21, 357],
       [ 74, 178,  98, 228],
       [  0, 336,   8, 412],
       [232,   0, 241,  92],
       [266,  79, 276,  94],
       [  0, 227,  22, 262],
       [337, 120, 352, 136],
       [176,  50, 194,  62],
       [137, 116, 204, 149],
       [234, 195, 247, 238],
       [352, 120, 364, 136],
       [210, 109, 228, 130],
       [291, 104, 374, 165]];
var captions = ['a headlight on a motorcycle', 'the shock absorber is silver', 'a headlight on the motorcycle', 'two motorcycles on the floor', 'a blue and black motorcycle', 'mirror on the motorcycle', 'a black motorcycle', 'a green fender on the motorcycle', 'the tire is black', 'a white tile wall', 'front tire of a motorcycle', 'front tire of a motorcycle', 'a mirror on the motorcycle', 'a motorcycle is parked', 'side view mirror on motorcycle', 'front wheel of motorcycle', 'a blue motorcycle', 'blue fender on bike', 'a green motorcycle handle', 'a black motorcycle engine', 'a blue fender on the motorcycle', 'a blue motorcycle', 'the handlebar of a motorcycle', 'a black seat on a motorcycle', 'a silver motorcycle exhaust pipe', 'a motorcycle is parked', 'a motorcycle right turn signal', 'a black motorcycle', 'the handle bar of a motorcycle', 'the handle bars of the motorcycle', 'the mirror on the motorcycle', 'the shock absorber of the bike', 'a mirror on the motorcycle', 'a motorcycle kickstand', 'front wheel of a motorcycle', 'a side view mirror', 'a motorcycle handle bar', 'the engine of a motorcycle', 'a reflection of a building in the window', 'the handle bar of a motorcycle', 'a motorcycle with a headlight', 'the spokes on the front wheel', 'a silver button on the front of the motorcycle', 'the mirror of a motorcycle', 'a motorcycle is parked', 'silver bolt on tire', 'a black motorcycle seat', 'the left handle bar of the motorcycle', 'part of a bike', 'the windshield on a motorcycle', 'a motorcycle handle', 'silver bolt on side of bike', 'front tire of a motorcycle', 'the front fork of the motorcycle', 'a black handle bar of a motorcycle', 'a small orange light', 'a mirror on the motorcycle', 'green light on front of bike', 'a motorcycle kickstand', 'a blue poster on the wall', 'the mirror on the motorcycle', 'a silver handle bar of a motorcycle', 'a green motorcycle handle', 'the shock absorber is black in color', 'the blue color on the bike', 'the mirror of a motorcycle', 'handle bars on the motorcycle', 'the pole is silver', 'the front fork of the motorcycle', 'the mirror of a motorcycle', 'a headlight on a motorcycle', 'the left handle bar of the motorcycle', 'a mirror on the motorcycle', 'black seat on a motorcycle', 'silver bolt on side of wheel', 'a side view mirror', 'a silver bolt on the motorcycle', 'the left side view mirror', 'the mirror on the motorcycle', 'green helmet on the motorcycle', 'the mirror of a motorcycle', 'a motorcycle handle bar', 'a motorcycle handle', 'a pink helmet on the motorcycle', 'silver bolt on side of wheel', 'a silver kickstand', 'the spoke of a wheel', 'a long pole', 'the mirror on the motorcycle', 'a black motorcycle seat', 'the mirror of a motorcycle', 'a silver handle bar', 'the seat of a motorcycle', 'a silver motorcycle brake', 'a side view mirror', 'a silver motorcycle handle', 'a motorcycle behind the other'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

