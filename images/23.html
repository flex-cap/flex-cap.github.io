<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '23.jpg';
var  boxes = [[185,  75, 195,  85],
       [181,  89, 238, 109],
       [ 79, 111, 178, 214],
       [  1,   1, 496, 332],
       [265, 222, 399, 309],
       [292, 153, 312, 173],
       [174, 139, 232, 168],
       [312, 136, 345, 169],
       [ 86, 140, 394, 231],
       [321, 228, 360, 241],
       [158,  39, 182,  64],
       [257, 138, 410, 330],
       [  0, 127,  98, 252],
       [291, 164, 385, 237],
       [266,   0, 339,  82],
       [271,  63, 426, 166],
       [166, 210, 192, 226],
       [ 76, 166, 100, 186],
       [111,  53, 183, 124],
       [256, 303, 287, 329],
       [265,   0, 482, 178],
       [279, 203, 499, 324],
       [197, 213, 266, 273],
       [  0, 125, 258, 264],
       [171, 195, 182, 205],
       [145,  64, 175,  94],
       [383, 281, 403, 306],
       [386, 235, 406, 261],
       [376, 205, 498, 305],
       [374, 136, 499, 188],
       [288, 151, 315, 186],
       [127,  68, 172, 112],
       [138,  88, 165, 112],
       [369, 176, 390, 202],
       [114, 222, 184, 247],
       [288, 170, 304, 185],
       [128,  76, 150, 103],
       [185, 188, 214, 226],
       [ 75, 223, 172, 254],
       [403, 209, 412, 218],
       [170, 199, 185, 213],
       [137,  40, 240, 111],
       [312, 136, 331, 157],
       [  0, 127,  43, 147],
       [ 90, 207, 260, 267],
       [350,   3, 497, 104],
       [291, 177, 314, 256],
       [263, 243, 298, 310],
       [363, 227, 401, 294],
       [321, 230, 366, 268],
       [171, 213, 209, 230],
       [374, 267, 399, 293],
       [343, 158, 410, 255],
       [276, 232, 326, 277],
       [292, 224, 385, 276],
       [356, 225, 379, 248],
       [305,   0, 334,  21],
       [306, 234, 319, 245],
       [ 84, 171, 166, 188],
       [122, 120, 148, 147],
       [270,  64, 327,  87],
       [381, 178, 409, 218],
       [291, 177, 313, 214],
       [358, 226, 373, 238],
       [ 93, 255, 236, 328],
       [338, 139, 347, 154],
       [212, 141, 396, 197],
       [287, 194, 402, 254],
       [286, 159, 322, 245],
       [ 79, 114, 119, 175],
       [107, 111, 142, 127],
       [332, 157, 349, 169],
       [315, 136, 338, 151],
       [ 76, 163,  92, 181],
       [187, 216, 209, 229],
       [389, 254, 498, 314],
       [132, 138, 180, 215],
       [  5,   0, 498, 144]];
var captions = ['a baseball in motion', 'a baseball bat', 'the pants is white', 'the batter is in the batters box', 'the umpire is wearing gray pants', 'a catchers mask', 'home plate of baseball game', 'a black protective helmet', 'the shadow of the batter', 'the belt is black', 'a black helmet on a batter', 'the umpire is crouching', 'white line on the field', 'the shirt is blue', 'white line on the field', 'white chalk line on a baseball field', 'a black and white shoe', 'a black shoe on a baseball players foot', 'the number 1 0 on a shirt', 'a black shoe on a baseball players foot', 'white lines on the field', 'shadow of the umpire', 'white chalk line on a baseball field', 'white chalk lines on a baseball field', 'the left foot of the batter', 'name on back of jersey', 'the foot of a man', 'knee of the catcher', 'shadow of the umpire', 'white chalk line on a baseball field', 'a catchers mask', 'the number 1 0 on a jersey', 'number 1 0 on the back of the batters jersey', 'the arm of a man', 'home plate in baseball game', 'the shirt is blue', 'number 1 9 on the back of a baseball jersey', 'shadow of the batter', 'home plate in batters box', 'the elbow of a man', 'the left foot of the batter', 'a baseball bat', 'the helmet is black in color', 'home plate on the baseball field', 'white chalk line on a baseball field', 'brown dirt on the field', 'the arm of a man', 'leg of the man', 'the leg of a man', 'the knee of a man', 'a black and white shoe', 'the knee of a man', 'the arm of a man', 'the knee of a man', 'the umpire is wearing black pants', 'the knee of a man', 'white line on the field', 'the knee of a man', 'shadow of the batter', 'the trouser is white in color', 'white chalk line on a baseball field', 'the arm of a man', 'the arm of a man', 'the belt is black in color', 'brown dirt on the field', 'the helmet is black in color', 'shadow of the umpire', 'umpire has black belt', 'the arm of a man', 'leg of a person', 'the batter is wearing a black belt', 'back of a mans blue shirt', 'the helmet is black in color', 'a black shoe on a baseball players foot', 'home plate in baseball game', 'shadow of the man', 'the leg of a man', 'white lines on the field'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

