<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '10.jpg';
var  boxes = [[155, 106, 422, 332],
       [ 72,  82, 107, 104],
       [  0,  78,  38,  95],
       [233,  49, 496,  75],
       [141,  77, 186,  87],
       [  0,  70, 493, 127],
       [203, 151, 298, 171],
       [426,  81, 442,  86],
       [328,  63, 373,  73],
       [329,  75, 350,  83],
       [199,  75, 218,  81],
       [415, 151, 499, 185],
       [283,  74, 301,  84],
       [335, 129, 454, 332],
       [210,  68, 451,  87],
       [173, 106, 307, 138],
       [128,  75, 149,  81],
       [269,  72, 281,  79],
       [  1,   0, 143,  62],
       [178,  36, 187,  63],
       [ 72, 100, 106, 118],
       [380,  76, 397,  82],
       [ 28,   0, 499,  64],
       [234,  69, 250,  74],
       [240,  75, 246,  79],
       [305,  74, 318,  80],
       [315,  76, 331,  82],
       [443,  74, 452,  78],
       [258,  72, 270,  77],
       [  1,  78, 195, 134],
       [253,  71, 302,  83],
       [ 41,  89,  49,  94],
       [405, 102, 496, 116],
       [309,  73, 377,  83],
       [296,  48, 377,  69],
       [230,  86, 236,  89],
       [397,  75, 408,  78],
       [  0,  94,  34, 108],
       [371,  74, 381,  79],
       [363,  74, 380,  80],
       [140,  84, 185,  99],
       [201,  70, 306,  88],
       [404,  76, 444,  86],
       [242,  71, 258,  76],
       [178, 121, 253, 139],
       [  0,  22,  39,  60],
       [232,  58, 306,  71],
       [315,  86, 322,  89],
       [154,  76, 172,  80],
       [370,  76, 491, 116],
       [  0, 144,  69, 153],
       [182,  80, 191,  89],
       [282,  71, 295,  77],
       [ 60, 153, 155, 160],
       [247, 117, 307, 135],
       [129,  70, 217,  88],
       [479,  84, 499,  94],
       [348, 111, 499, 135],
       [  0, 248, 182, 331],
       [212,  84, 215,  87],
       [  0,   0,  63,  60],
       [ 21,   0,  53,  17],
       [178, 106, 198, 137],
       [350,  78, 368,  82],
       [408,  91, 412,  94],
       [401, 135, 423, 178],
       [266,  86, 270,  88],
       [407, 102, 417, 106],
       [181,  71, 190,  89],
       [141,  78, 163,  86],
       [285,  79, 300,  84],
       [296,  69, 310,  72],
       [214,  70, 241,  76],
       [ 74,  82, 103,  95],
       [ 31,  10,  93,  62],
       [ 98,  51, 126,  63],
       [397, 101, 401, 103],
       [ 56,  27,  90,  60],
       [200,  87, 203,  89],
       [343,  76, 361,  82],
       [208,  72, 219,  77],
       [206,  50, 259,  73],
       [382,  72, 389,  75],
       [160,  80, 187,  88],
       [180,  89, 188, 105],
       [253,  84, 256,  86],
       [324,  72, 339,  77],
       [135,  88, 139,  91],
       [464,  81, 467,  83],
       [146,  62, 149,  78],
       [307,  71, 319,  76],
       [162, 115, 389, 152],
       [377,  75, 410,  83],
       [281,  84, 287,  87],
       [400, 101, 404, 103],
       [389,  63, 457,  75],
       [396, 100, 430, 108],
       [102,  19, 129,  57],
       [182,  69, 188,  80],
       [420,  90, 423,  92],
       [141,  38, 162,  68],
       [214,  84, 217,  86],
       [419, 103, 431, 109],
       [ 41,  94,  48,  99],
       [243,  85, 245,  87],
       [144,  53, 169,  64],
       [216, 130, 245, 137],
       [337,  75, 347,  81],
       [156, 110, 399, 184],
       [180,  73, 183,  78],
       [113,  58, 140,  64],
       [468,  73, 498,  80],
       [211,  69, 235,  73],
       [ 70,  95,  78, 103],
       [434,  70, 440,  72],
       [207,  62, 245,  72],
       [ 22,  83,  38,  93],
       [364,  79, 371,  82],
       [391, 174, 413, 205],
       [269, 109, 360, 118],
       [ 10,  80,  26,  92],
       [181,  86, 188,  94],
       [  0,  55, 492,  85],
       [346,  80, 351,  83]];
var captions = ['boat on the shore', 'a small white boat', 'a blue boat in the water', 'buildings in the background', 'boat in the water', 'the water is calm', 'the boat has a white writing on the side', 'a boat in the water', 'a yellow building in the background', 'boat in the water', 'boat on the water', 'a rope on the boat', 'boat in the water', 'a rope tied to a boat', 'boats in the water', 'blue interior of boat', 'a boat in the water', 'boat in the water', 'white buildings in the background', 'a tall palm tree', 'boat in the water', 'a boat in the water', 'the sky is cloudy', 'boat in the water', 'a boat in the water', 'boat in the water', 'boat in the water', 'a boat in the water', 'boat in the water', 'the water is calm', 'boats in the water', 'a bird in the water', 'a pile of seaweed', 'boats in the water', 'buildings in the background', 'a bird in the water', 'a boat in the water', 'a blue boat on the shore', 'a boat in the water', 'a boat in the water', 'the water is calm', 'boats in the water', 'boats in the water', 'boat in the water', 'a brown rope on the boat', 'white building on the shore', 'buildings in the background', 'a bird in the water', 'a boat in the water', 'the water is calm', 'a rope on the ground', 'a person walking on the shore', 'boat in the water', 'a rope on the ground', 'a blue seat on a boat', 'boats in the water', 'a boat on the water', 'a small patch of sand', 'a rope on the ground', 'a bird in the water', 'white building on the shore', 'a white building', 'a rope tied to the boat', 'a boat in the water', 'a bird in the water', 'a small boat anchor', 'a bird in the water', 'a bird on the ground', 'person walking on the shore', 'boat in the water', 'boat in the water', 'a boat in the water', 'boats in the water', 'a small white boat', 'white buildings in the background', 'a white building in the distance', 'a bird in the water', 'white building in the background', 'a bird in the water', 'boat in the water', 'a boat in the water', 'buildings in the distance', 'a boat in the water', 'a boat in the water', 'a person standing on the shore', 'a bird in the water', 'boat in the water', 'a white bird in the water', 'a bird in the water', 'a person standing on the shore', 'boat in the water', 'the boat has a tarp', 'boat on the water', 'a bird in the water', 'a bird in the water', 'buildings in the distance', 'birds on the ground', 'a white building in the distance', 'person walking on the shore', 'a bird in the water', 'a tall green tree', 'a bird in the water', 'a bird on the ground', 'a bird in the water', 'a bird in the water', 'a white building in the distance', 'a brown rope on the boat', 'boat in the water', 'the boat is blue', 'person walking on the shore', 'a white building in the distance', 'a boat in the water', 'boats in the water', 'a boat in the water', 'a boat in the water', 'boats in the water', 'a small boat in the water', 'a white bird in the water', 'a white stripe on the boat', 'a wooden oar on the boat', 'a blue boat in the water', 'a person walking by the water', 'a city in the background', 'a bird in the water'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

