<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Generating Rich, Localized, and  Flexible Captions in Images.">
  <meta name="keywords" content="Flexible, Captions, VQA, Visual Recognition, Visual Dialog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlexCap: Generating Rich, Localized, and  Flexible Captions in Images</title>
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="../static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="../static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="icon" href="../static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script src="../static/js/bulma-carousel.min.js"></script>
  <script src="../static/js/bulma-slider.min.js"></script>
  <script src="../static/js/index.js"></script>
  <style>
    canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
  <script>
  var imageUrl = '31.jpg';
var  boxes = [[236, 115, 494, 291],
       [ 14,  92, 246, 251],
       [159,   0, 499,  58],
       [362,  79, 492, 273],
       [393, 191, 481, 276],
       [ 87, 118, 201, 167],
       [225, 141, 250, 201],
       [249, 116, 361, 143],
       [462, 172, 496, 237],
       [459, 264, 472, 275],
       [459, 193, 476, 275],
       [374,  81, 447, 132],
       [ 12,  80, 491, 291],
       [443, 197, 462, 274],
       [  2, 174, 498, 332],
       [419, 196, 463, 292],
       [  4,   4, 498,  95],
       [ 25,  93, 116, 115],
       [ 16, 162,  24, 171],
       [458, 126, 489, 199],
       [309, 265, 325, 277],
       [ 19, 161,  33, 174],
       [395, 208, 412, 251],
       [ 84, 230,  98, 244],
       [ 20,  94,  42, 119],
       [ 99, 240, 112, 248],
       [248, 151, 255, 155],
       [205, 239, 218, 250],
       [320, 272, 336, 281],
       [  1,   6, 237,  79],
       [ 26, 120,  36, 130],
       [374,  80, 384,  96],
       [100, 231, 114, 246],
       [242, 183, 257, 197],
       [278, 130, 321, 183],
       [ 41, 101, 117, 156],
       [449, 129, 490, 262],
       [266,  61, 289,  70],
       [310, 266, 338, 282],
       [ 31,  99, 218, 166],
       [373,  79, 394, 103],
       [ 87, 172, 105, 244],
       [ 91, 162, 114, 245],
       [111, 133, 194, 169],
       [318, 194, 340, 282],
       [436, 122, 452, 131],
       [177, 236, 194, 251],
       [453, 127, 472, 179],
       [243, 126, 258, 141],
       [384,  77, 394,  91],
       [114, 155, 185, 178],
       [246, 179, 254, 187],
       [ 14, 132,  39, 174],
       [ 25, 128,  34, 136],
       [ 23, 154,  33, 161],
       [ 67, 109,  77, 151],
       [ 23, 157,  33, 166],
       [425, 281, 442, 292],
       [247, 180, 259, 189],
       [  4,   0, 146,  10],
       [420, 299, 476, 322],
       [286,  14, 310,  28],
       [204, 172, 223, 247],
       [ 71, 109,  93, 157],
       [234, 124, 287, 199],
       [396, 101, 414, 141],
       [379, 110, 387, 117],
       [134, 124, 143, 158],
       [323, 143, 431, 198],
       [ 13,  95,  52, 174],
       [247,  66, 496, 101],
       [232, 174, 255, 202],
       [ 75, 111,  82, 150],
       [  0,  14, 267, 188],
       [179, 169, 219, 249],
       [239, 149, 275, 194],
       [260, 130, 435, 200],
       [391, 143, 451, 151],
       [363,  85, 398, 146],
       [394, 203, 438, 291],
       [412, 113, 445, 133],
       [385,  87, 397,  98],
       [147,   8, 340,  71],
       [252, 126, 351, 190],
       [390, 281, 405, 291],
       [  0, 271, 230, 329],
       [ 20,  93,  30, 104],
       [ 19, 103,  28, 113],
       [465, 184, 481, 221],
       [239, 307, 243, 310],
       [425, 103, 450, 130],
       [ 24, 147,  41, 162],
       [475, 169, 487, 199],
       [251, 127, 267, 145],
       [ 26,  94, 214, 130],
       [469, 198, 480, 217],
       [245, 127, 281, 149],
       [228,  40, 233,  42],
       [ 18, 302,  22, 306],
       [434, 191, 461, 229]];
var captions = ['a zebra walking on dirt', 'a zebra walking on dirt', 'a rock wall behind the zebras', 'a zebra standing on the dirt', 'the legs of the zebra', 'black and white stripes of a zebra', 'tail of a zebra', 'the mane of the zebra', 'tail of a zebra', 'the hoof of a zebra', 'a zebras back leg', 'the head of a zebra', 'the zebras are black and white in color', 'a zebras leg', 'shadows of zebras on the ground', 'the hind legs of a zebra', 'a dirt path', 'the mane of the zebra', 'the zebras nose is black', 'tail of a zebra', 'the hoof of a zebra', 'the zebras nose is black', 'leg of a zebra', 'the hoof of a zebra', 'the ear of a zebra', 'the hoof of a zebra', 'the eye of a zebra', 'back left hoof of zebra', 'the hoof of a zebra', 'a dirt path', 'the eye of a zebra', 'the ear of a zebra', 'the hoof of a zebra', 'the nose of a zebra', 'neck of a zebra', 'the neck of a zebra', 'tail of a zebra', 'a small rock on the ground', 'zebra hoof is black', 'the zebra has black and white stripes', 'the ear of a zebra', 'a zebras front left leg', 'leg of a zebra', 'black and white stripes of a zebra', 'a black and white zebras feet', 'the zebra has a black spot', 'the hoof of a zebra', 'tail of a zebra', 'the ear of a zebra', 'the ear of a zebra', 'the belly of a zebra', 'the nose of a zebra', 'the zebras nose is black', 'the eye of a zebra', 'the nose of a zebra', 'black stripe on zebra', 'the zebras nose is black', 'hoof of a zebra', 'the nose of a zebra', 'a patch of grass', 'a shadow on the ground', 'a rock on wall', 'a zebras right leg', 'black stripe on zebra', 'the head of a zebra', 'the zebras nose is black', 'the zebra has a nose', 'the black strip of the zebra', 'the stripes of a zebra', 'the head of the zebra', 'a patch of grass', 'the nose of a zebra', 'black stripe on zebra', 'a dirt path', 'the right leg of a zebra', 'the zebra has a nose', 'the zebra is striped', 'the zebra has a mane', 'the zebra has a black and white mane', 'leg of a zebra', 'the zebras nose is black', 'the ear of a zebra', 'a shadow on the ground', 'the neck of a zebra', 'hoof of a zebra', 'the shadow of the zebra', 'the ear of a zebra', 'the zebras ear', 'tail of a zebra', 'white mark is spotted', 'the zebras mane is black', 'the nose of a zebra', 'tail of a zebra', 'the ear of a zebra', 'the mane of the zebra', 'tail of a zebra', 'the ear of a zebra', 'a small rock on the ground', 'a small white rock', 'the zebras tail is short'];

  </script>
  </head>
  <body>
    <section class="hero">
      <div class="hero-body">
          <div class="container is-max-desktop">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h2 class="is-centered has-text-centered title is-3">Draw a bounding box to see a caption.</h2>
              <h2 class="is-centered has-text-centered title is-4">Or click one of the options below.</h2>
              <div class="column has-text-centered">
                <div class="publication-links">
                  <!-- Boxes link. -->
                  <span class="link-block">
                    <button id="button5"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Clear</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button2"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 5 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button3"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 10 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button4"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show Top 50 boxes</span>
                  </button>
                  </span>
                  <span class="link-block">
                    <button id="button1"
                        class="external-link button is-normal is-rounded is-dark">
                      <span>Show all boxes</span>
                  </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function displayBoundingBoxes(imageUrl, boxes, captions) {
        var image = new Image();

        // Set the source of the image element to the given image URL
        image.src = imageUrl;

        image.onload = function() {
          paddingY = 30;
          paddingX = 400;
          // Get the dimensions of the image
          var imgWidth = image.width;
          var imgHeight = image.height;
          // Create a canvas element
          var canvas = document.createElement('canvas');
          canvas.width = imgWidth + paddingX*2;
          canvas.height = imgHeight + paddingY;
          var context = canvas.getContext('2d');

          // Draw the image on the canvas
          context.drawImage(image, paddingX, 0);

          // Initialize bounding box coordinates
          var startX, startY, endX, endY;
          function typewriter(currentBox, text) {
              var i = 0;
              var x = currentBox[0]+paddingX;
              var y = currentBox[3]+ 20;

              var intervalId = setInterval(function() {
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 0.75;
                // Draw a semi-transparent rectangle behind the text
                context.fillStyle = "black";
                context.fillRect(x, currentBox[3]+6, context.measureText(text[i]).width, 20);
                // Set the globalAlpha property of the canvas context
                context.globalAlpha = 1.0;

                context.font = '20px Arial';
                context.fillStyle = 'white';
                context.fillText(text[i], x, y);
                x += context.measureText(text[i]).width; // increment x by the width of the character
                i++;
                if (i === text.length) {
                  clearInterval(intervalId);
                }}, 10);
            }

          function drawbox(bestBox, caption, bestIoU, clearOthers, color="green"){
            // Draw the bounding box
            if (bestBox && bestIoU>0.1) {
              // Clear the canvas
              if (clearOthers) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, paddingX, 0);
              }
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = color;
              context.rect(bestBox[0]+paddingX, bestBox[1], bestBox[2] - bestBox[0], bestBox[3] - bestBox[1]);
              context.stroke();
              console.log("bestBox:", bestBox, "bestIoU", bestIoU, "text",  caption);
              typewriter(bestBox, caption);
              // context.clearRect(startX, startY, endX-startX, endY-startY)
            }
            else {
              typewriter([startX-paddingX, startY, endX, endY], "No Match");
            }
          }

         for (var i = 0; i < 5; i++) {
          color = "#"+((1<<24)*Math.random()|0).toString(16);
          drawbox(boxes[i], captions[i], 1.0, false, color) }


          // Add event listeners for mouse actions
          var isDrawing = false;
          var bestBox = null;
          canvas.addEventListener('mousedown', function(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDrawing = true;
             bestBox = null;
          });

          canvas.addEventListener('mousemove', function(e) {
            if (isDrawing) {
              var currentX = e.clientX - canvas.offsetLeft;
              var currentY = e.clientY - canvas.offsetTop;

              // Clear the canvas
              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(image, paddingX, 0);

              // Draw the bounding box
              context.beginPath();
              context.lineWidth = "4";
              context.strokeStyle = "red";
              var width = currentX - startX;
              var height = currentY - startY;
              context.rect(startX, startY, width, height);
              context.stroke();

              // Update bounding box coordinates
              endX = currentX;
              endY = currentY;
            }
          });

          canvas.addEventListener('mouseup', function(e) {
            isDrawing = false;

            // Order coords in increasing order.
            startXC = Math.min(startX, endX);
            startYC = Math.min(startY, endY);
            endXC = Math.max(startX, endX);
            endYC = Math.max(startY, endY);
            startX = startXC;
            endX = endXC
            startY = startYC;
            endY = endYC;

            console.log("Start X:", startX, "Start Y:", startY, "End X:", endX, "End Y:", endY);

            var bestIoU = 0.0;
            var caption = 'No Match'
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              var intersectionX1 = Math.max(box[0]+paddingX, startX);
              var intersectionY1 = Math.max(box[1], startY);
              var intersectionX2 = Math.min(box[2]+paddingX, endX);
              var intersectionY2 = Math.min(box[3], endY);
              var intersectionWidth = Math.max(0, intersectionX2 - intersectionX1);
              var intersectionHeight = Math.max(0, intersectionY2 - intersectionY1);
              var intersectionArea = intersectionWidth * intersectionHeight;
              var boxArea = (box[2] - box[0]) * (box[3] - box[1]);
              var drawnBoxArea = (endX - startX) * (endY - startY);
              var unionArea = boxArea + drawnBoxArea - intersectionArea;
              var iou = intersectionArea / (unionArea+1e-6);
              if (iou > bestIoU) {
                bestBox = box;
                bestIoU = iou;
                caption = captions[i]
              }
            }
            drawbox(bestBox, caption, bestIoU, true);


          });
          // Add the canvas to the document body
          document.body.appendChild(canvas);
          button = document.getElementById('button1');
          // Add an event listener to the button
          button.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < boxes.length; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button2 = document.getElementById('button2')
          // Add an event listener to the button
          button2.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 5; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button3 = document.getElementById('button3')
          // Add an event listener to the button
          button3.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 10; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button4 = document.getElementById('button4')
          // Add an event listener to the button
          button4.addEventListener("click", function() {
          // Do something when the button is clicked
          for (var i = 0; i < 50; i++) {
            // Random Color
            color = "#"+((1<<24)*Math.random()|0).toString(16);
            drawbox(boxes[i], captions[i], 1.0, (i==0), color=color) }});

          button5 = document.getElementById('button5')
          // Add an event listener to the button
          button5.addEventListener("click", function() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, paddingX, 0);});

        };
      }
      displayBoundingBoxes(imageUrl, boxes, captions);
  </script>
</body>
</html>

